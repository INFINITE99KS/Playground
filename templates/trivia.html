{% extends "layout.html" %}
{% block title %}
Trivia
{% endblock %}

{% block body %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-10 col-sm-8 col-md-6 col-lg-4 mb-3">
      <div class="card bg-dark text-light h-100 rounded-4 overflow-hidden position-relative p-2">
        <div class="card-body d-flex flex-column">
          <h3>Trivia</h3>
          <p class="card-text flex-grow-1">Think you know it all? Letâ€™s test that brain of yours.</p>

          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-secondary">Your Score:</small>
            <span id="score" class="fw-bold text-info">0 / 3</span>
          </div>

          <div id="trivia-container" class="mb-3"></div>

          <div class="text-center mt-auto">
            <button class="btn btn-info w-100" onclick="loadTrivia()">Reload Questions</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let score = 0;
let total = 3;

async function loadTrivia() {
  score = 0;
  document.getElementById('score').textContent = `${score} / ${total}`;
  const container = document.getElementById("trivia-container");
  container.innerHTML = `<div class="text-center text-secondary">Loading questions...</div>`;

  try {
    const res = await fetch("https://opentdb.com/api.php?amount=3&type=multiple");
    const data = await res.json();

    const html = data.results.map((q, i) => {
      const answers = [...q.incorrect_answers, q.correct_answer].sort(
        () => Math.random() - 0.5
      );
      return `
        <div class="mb-3 border border-secondary rounded-3 p-2" data-answer="${q.correct_answer}">
          <strong>Q${i + 1}:</strong> ${q.question}<br>
          ${answers
            .map(
              (a, idx) => `
              <div class="form-check mt-1">
                <input class="form-check-input" type="radio" name="q${i}" id="q${i}_${idx}" value="${a}">
                <label class="form-check-label" for="q${i}_${idx}">${a}</label>
              </div>`
            )
            .join("")}
        </div>`;
    }).join("");

    container.innerHTML = html;

    // Handle answer checking
    document.querySelectorAll('#trivia-container .form-check-input').forEach(input => {
      input.addEventListener('change', (e) => {
        const questionDiv = e.target.closest('[data-answer]');
        const correctAnswer = questionDiv.dataset.answer;

        // Disable all inputs for this question
        questionDiv.querySelectorAll('input').forEach(i => i.disabled = true);

        // Highlight answers
        questionDiv.querySelectorAll('label').forEach(label => {
          const inputEl = label.previousElementSibling;
          if (label.textContent.trim() === correctAnswer.trim()) {
            label.classList.add('text-success', 'fw-bold');
          }
          if (inputEl.checked && label.textContent.trim() !== correctAnswer.trim()) {
            label.classList.add('text-danger');
          }
        });

        // Update score if correct
        if (e.target.value.trim() === correctAnswer.trim()) {
          score++;
          document.getElementById('score').textContent = `${score} / ${total}`;
        }
      });
    });
  } catch (err) {
    container.innerHTML = `<div class="alert alert-danger">Failed to load trivia questions ðŸ˜¢</div>`;
    console.error(err);
  }
}

loadTrivia();
</script>
{% endblock %}
